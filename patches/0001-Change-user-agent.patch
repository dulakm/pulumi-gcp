From 088ff54d4ab901c5a9058a8b82cc2bfaf1ce3676 Mon Sep 17 00:00:00 2001
From: Daniel Bradley <daniel@pulumi.com>
Date: Tue, 7 Mar 2023 11:09:59 +0000
Subject: [PATCH 1/9] Change user agent

Remove implementation of generateUserAgentString as it's not needed in our provider. We set the user agent on the config and always use that value as-is for all requests.

Add options to set or disable partner name.
---
 google-beta/provider.go | 28 ++++++++++++++++++++++++++++
 google-beta/utils.go    |  6 +++---
 2 files changed, 31 insertions(+), 3 deletions(-)

diff --git a/google-beta/provider.go b/google-beta/provider.go
index 3469e3543..52246cbe5 100644
--- a/google-beta/provider.go
+++ b/google-beta/provider.go
@@ -230,6 +230,19 @@ func Provider() *schema.Provider {
 				Optional: true,
 			},
 
+			"google_partner_name": {
+				Type:     schema.TypeString,
+				Optional: true,
+			},
+
+			"disable_google_partner_name": {
+				Type:     schema.TypeBool,
+				Optional: true,
+				DefaultFunc: schema.MultiEnvDefaultFunc([]string{
+					"GOOGLE_DISABLE_PARTNER_NAME",
+				}, nil),
+			},
+
 			"request_reason": {
 				Type:     schema.TypeString,
 				Optional: true,
@@ -1810,6 +1823,21 @@ func providerConfigure(ctx context.Context, d *schema.ResourceData, p *schema.Pr
 		UserAgent:           p.UserAgent("terraform-provider-google-beta", version.ProviderVersion),
 	}
 
+	disablePartnerName := d.Get("disable_google_partner_name").(bool)
+	userSpecifiedPartnerName := d.Get("google_partner_name")
+
+	partnerString := ""
+	if !disablePartnerName {
+		if userSpecifiedPartnerName != "" {
+			partnerString = fmt.Sprintf("GPN:%s; ", userSpecifiedPartnerName)
+		} else {
+			partnerString = "GPN:Pulumi; "
+		}
+	}
+	userAgent := fmt.Sprintf("Pulumi/3.0 (%shttps://www.pulumi.com) pulumi-gcp/%s", partnerString, version.ProviderVersion)
+
+	config.UserAgent = userAgent
+
 	// opt in extension for adding to the User-Agent header
 	if ext := os.Getenv("GOOGLE_TERRAFORM_USERAGENT_EXTENSION"); ext != "" {
 		ua := config.UserAgent
diff --git a/google-beta/utils.go b/google-beta/utils.go
index 31e866363..eb0f240c6 100644
--- a/google-beta/utils.go
+++ b/google-beta/utils.go
@@ -283,10 +283,10 @@ func changeFieldSchemaToForceNew(sch *schema.Schema) {
 	tpgresource.ChangeFieldSchemaToForceNew(sch)
 }
 
-// Deprecated: For backward compatibility generateUserAgentString is still working,
-// but all new code should use GenerateUserAgentString in the tpgresource package instead.
 func generateUserAgentString(d tpgresource.TerraformResourceData, currentUserAgent string) (string, error) {
-	return tpgresource.GenerateUserAgentString(d, currentUserAgent)
+	// we don't want to append the name of the module here as it doesn't make any sense to
+	// do this with the pulumi provider
+	return currentUserAgent, nil
 }
 
 // Deprecated: For backward compatibility snakeToPascalCase is still working,
-- 
2.41.0

